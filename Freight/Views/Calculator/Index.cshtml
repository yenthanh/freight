@{
    ViewBag.Title = "Caculator";
    var role = ViewBag.role;
}
<style>
    .input-group-lg > .form-control:not(textarea), .input-group-lg > .custom-select {
        font-size: 15px;
    }

    .form-control-lg {
        width: 100%;
        height: 48px;
        max-width: 91%;
    }

    .form-select {
        height: 48px;
        font-size: 15px;
    }

    .form-control {
        font-size: 1.5rem;
    }

    label {
        font-size: 15px;
    }

    h3 {
        font-size: 20px;
        font-family: Roboto,sans-serif;
    }

    h4 {
        font-size: 13px;
    }
</style>


@Html.Partial("~/Views/_Header.cshtml")
@section sidebar{
    <div class="nav-side-menu">
        <i class="fa fa-lg fa-bars fa-2x toggle-btn" data-toggle="collapse" data-target="#menu-content"></i>

        <div class="menu-list">

            <ul id="menu-content" class="menu-content collapse out">
                @foreach (var m in MM_Freight_Rate_API_Backend.Hepler.ListModules)
                {
                    <a href="@m.URL" style="text-decoration:none">
                        <li data-toggle="collapse" class="collapsed" data-target="#products">
                            <i class="fa fa-lg @m.ICON_IMAGE" style="padding-right:10px"></i>
                            @m.MODULE_NAME
                        </li>
                    </a>
                }
        </div>
    </div>
}
<body>
    <div style="min-height:80vH">
        <section>
            <h3>Freight Rates Portal</h3>
            <div>
                <input type="text" value="@role" id="role" hidden />
                <div class="row">
                    <div class="col-xs-6 col-md-4" style="margin-top:15px;">
                        <label>Origin<i style="color:red" title="Required">*</i></label>
                        <select class="form-select form-control-lg mb-5" id="sourceSelect">
                            <option value="">Please Select a Country</option>
                        </select>
                    </div>

                    <div class="col-xs-6 col-md-4" style="margin-top: 15px; ">
                        <label>Destination<i style="color:red" title="Required">*</i></label>
                        <select class="form-select form-control-lg mb-5" id="destinationSelect">
                            <option value="">Please Select a Country</option>
                        </select>
                    </div>
                    <div class="col-xs-6 col-md-4" style="margin-top: 15px; ">
                        <label>Carrier</label>
                        <select class="form-select form-control-lg mb-5" id="carrierSelect">
                            <option value="">Please Select a Carrier</option>
                        </select>
                    </div>

                </div>
                <div class="row">
                    <div class="col-xs-6 col-md-4">
                        <label id="lableService">Service Type</label>
                        <select class="form-select form-control-lg mb-5" id="servicesSelect">
                            <option selected value="">Please select carrier firstly</option>
                        </select>
                    </div>

                    <div class="col-xs-6 col-md-4">
                        <label id="lablePackaging">Packaging Type</label>
                        <select class="form-select form-control-lg mb-5" id="packagingSelect">
                            <option selected value="">Please select carrier firstly</option>
                        </select>
                    </div>
                    <div class="col-xs-6 col-md-4">
                        <label for="exampleInputEmail1">Weight</label>
                        <div class="input-group-lg mb-lg-5, col-xl-12" style="margin-left: -15px; display: flex;">
                            <input type="text" id="weightSelect" placeholder="Weight" class="form-control" aria-label="Weight" style="max-width:395px">
                            <div class="input-group-append">
                                <span class="input-group-text">Kg</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">

                    <div class="col-xs-6 col-md-4" style="margin-top:15px;" id="lengthGroup">
                        <label for="exampleInputEmail1">Length</label>
                        <div class="input-group-lg mb-lg-5, col-xl-12" style="margin-left: -15px; display: flex">
                            <input type="text" id="txtLength" placeholder="Length" class="form-control" aria-label="Weight" style="max-width: 395px">
                            <div class="input-group-append">
                                <span class="input-group-text">CM</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6 col-md-4" style="margin-top:15px" id="widthGroup">
                        <label for="exampleInputEmail1">Width</label>
                        <div class="input-group-lg mb-lg-5, col-xl-12" style="margin-left: -15px; display: flex">
                            <input type="text" id="txtWidth" placeholder="Width" class="form-control" aria-label="Weight" style="max-width: 395px">
                            <div class="input-group-append">
                                <span class="input-group-text">CM</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6 col-md-4" style="margin-top:15px;" id="heightGroup">
                        <label for="exampleInputEmail1">Height</label>
                        <div class="input-group-lg mb-lg-5, col-xl-12" style="margin-left: -15px; display: flex">
                            <input type="text" id="txtHeight" placeholder="Height" class="form-control" aria-label="Weight" style="max-width: 395px">
                            <div class="input-group-append">
                                <span class="input-group-text">CM</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div style="margin-top:20px">
                    <button type="button" class="btn btn-primary btn-lg" id="searchButton">Search</button>
                </div>
            </div>
            <div style="margin-top:50px">
                <h3>
                    Corporate Rate
                </h3>
                <div class="col-md-6 mr-0 row">
                    <label class="col-md-12 row">Search:</label>
                    <input type="text" id="myInput" onkeyup="search()" style="max-width: 395px" class="form-control" placeholder="Search for carrier..">
                </div>
                <table class="table" id="tbResult">
                    <thead>
                        <tr>
                            <th scope="col">Carrier</th>
                            <th scope="col">Service Type</th>
                            <th scope="col">Packaging Type</th>
                            <th scope="col">Weight Range(kg)</th>
                            <th scope="col">Current FSC</th>
                            <th scope="col">Working days(day)</th>
                            <th scope="col">Rate Before Surcharge (SGD)</th>
                            <th scope="col">Rate After Surcharge (SGD)</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <p style="margin-top:60px;margin-bottom:60px">
                <b>Disclaimers:</b><br />
                ·       Customs duties, taxes, service charges and clearance related charges and any other fees (where applicable) are not included in the tariffs.<br />
                ·       Freight rates effective for the current calendar year.
            </p>
            <a href="#" id="btnExport" class="btn btn-primary btn-lg">Export</a>
        </section>
        <footer style=" position:absolute;top:100%; font-size:15px;margin-top:10px;">
            <label style="font-weight: normal">Copyright Mentor Media, 2021</label>
        </footer>
    </div>
</body>

<script src="~/Scripts/jquery-3.4.1.js"></script>
<script>
    $(document).ready(function () {

        function exportTableToCSV($table, filename) {

            var $rows = $table.find('tbody tr:has(td)'),

                // Temporary delimiter characters unlikely to be typed by keyboard
                // This is to avoid accidentally splitting the actual contents
                tmpColDelim = String.fromCharCode(11), // vertical tab character
                tmpRowDelim = String.fromCharCode(0), // null character

                // actual delimiter characters for CSV format
                colDelim = ',',
                rowDelim = '\r\n',

                // Grab text from table into CSV formatted string
                csv = $rows.map(function (i, row) {
                    var $row = $(row),
                        $cols = $row.find('td');

                    return $cols.map(function (j, col) {
                        var $col = $(col),
                            text = $col.text();

                        return text;//.replace(/"/g, '""'); // escape double quotes

                    }).get().join(tmpColDelim);

                }).get().join(tmpRowDelim)
                    .split(tmpRowDelim).join(rowDelim)
                    .split(tmpColDelim).join(colDelim);// + '"';
            csv = "Carrier,Service Type,Packaging Type,Weight Range(kg),Current FSC	Working days(day),Rate Before Surcharge (SGD),Rate After Surcharge (SGD)" + rowDelim + csv;
            csv += rowDelim + "Disclaimers:";
            csv += rowDelim + "Customs duties; taxes; service charges and clearance related charges and any other fees (where applicable) are not included in the tariffs.";
            csv += rowDelim + "Freight rates effective for the current calendar year.";

            // Deliberate 'false', see comment below
            if (false && window.navigator.msSaveBlob) {

                var blob = new Blob([decodeURIComponent(csv)], {
                    type: 'text/csv;charset=utf8'
                });

                // Crashes in IE 10, IE 11 and Microsoft Edge
                // See MS Edge Issue #10396033
                // Hence, the deliberate 'false'
                // This is here just for completeness
                // Remove the 'false' at your own risk
                window.navigator.msSaveBlob(blob, filename);

            } else if (window.Blob && window.URL) {
                // HTML5 Blob        
                var blob = new Blob([csv], {
                    type: 'text/csv;charset=utf-8'
                });
                var csvUrl = URL.createObjectURL(blob);

                $(this)
                    .attr({
                        'download': filename,
                        'href': csvUrl
                    });
            } else {
                // Data URI
                var csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

                $(this)
                    .attr({
                        'download': filename,
                        'href': csvData,
                        'target': '_blank'
                    });
            }
        }

        // This must be a hyperlink

        $("#btnExport").click(function () {
            // CSV
            var args = [$('#tbResult'), 'export.csv'];

            exportTableToCSV.apply(this, args);

            // If CSV, don't do event.preventDefault() or return false
            // We actually need this to be a typical hyperlink
        });
   
        var arr = [];

        var serviceOptionDefault = " <option selected value='0'>Services Type</option>";
        var pakagingOptionDefault = "<option selected value='0'>Packaging Type</option>";
        var weightOptionDefault = "<option selected value='0'>Weight</option>";
        $.ajax({
            type: "GET",
            url: "/Utility/GetListCountry",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var s = '<option value="">Please Select a Country</option>';
                for (var i = 0; i < data.data.length; i++) {
                    s += '<option value="' + data.data[i].text + '">' + data.data[i].text + '</option>';
                }
                $("#sourceSelect").html(s);
                $("#destinationSelect").html(s);
            }
        });
        $.ajax({
            type: "GET",
            url: "/Utility/GetListCarriers",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var s = '<option value="">Please Select a Carrier</option>';
                for (var i = 0; i < data.data.length; i++) {
                    s += '<option value="' + data.data[i].value + '">' + data.data[i].text + '</option>';
                }
                $("#carrierSelect").html(s);
            }
        });


        // Event choose carrier
        $("#carrierSelect").change(function () {
            var valueOfCarrier = $("#carrierSelect").val();
            if (valueOfCarrier !== "0") {
                var lableService = '<label id="lableService">Service Type<i style="color:red" title="Required">*</i></label>';
                $("#lableService").html(lableService);
                var lablePackaging = '<label id="lablePackaging">Packaging Type<i style="color:red" title="Required">*</i></label>';
                $("#lablePackaging").html(lablePackaging);
            }
            else {
                var lableService = '<label id="lableService">Service Type</label>';
                $("#lableService").html(lableService);
                var lablePackaging = '<label id="lablePackaging">Packaging Type</label>';
                $("#lablePackaging").html(lablePackaging);
            }

            $.ajax({
                type: "GET",
                url: "/Utility/GetListPackageTypeByCarrier?carrier=" + valueOfCarrier,
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    var s = '<option value="">Please Select a Packing Type</option>';
                    for (var i = 0; i < data.data.length; i++) {
                        s += '<option value="' + data.data[i].value + '">' + data.data[i].text + '</option>';
                    }
                    $("#packagingSelect").html(s);
                }
            });

            $.ajax({
                type: "GET",
                url: "/Utility/GetListServices",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function (data) {

                    var carrier = $("#carrierSelect").val();
                    var s = '<option value="">Please Select a Service Type</option>';
                    for (var i = 0; i < data.data.length; i++) {
                        if (carrier == '' || carrier == data.data[i].extend) {
                            s += '<option value="' + data.data[i].value + '">' + data.data[i].text + '</option>';
                        }
                    }
                    $("#servicesSelect").html(s);
                }
            });

            $("#weightSelect").html(weightOptionDefault);
            var servicesForFedex = serviceOptionDefault + "<option value='1'>Priority (IP)</option>"
                + "<option value='2'>Economy (IE)</option>"
                + "<option value='3'>Priority Freight</option>"
                + "<option value='4'>Economy Freight</option>";
            var servicesForDHL = serviceOptionDefault + "<option value='5'>Express</option>";
            var value = $(this).val();
            if (value == '1')
                $("#servicesSelect").html(servicesForFedex);
            if (value == '2')
                $("#servicesSelect").html(servicesForDHL);
            if (value == '0')
                $("#servicesSelect").html(serviceOptionDefault);

        });
        // Event when choose services type
        $("#servicesSelect").change(function () {
            $("#weightSelect").html(weightOptionDefault);
            var packagingTypeForService1Or2 = pakagingOptionDefault + "<option value='1'>Envelope (Doc)</option>"
                + "<option value='2'>Pak</option>"
                + "<option value='3'>Package</option>";
            var packagingTypeForService3Or4 = pakagingOptionDefault + "<option value='4'>NIL.</option>";
            var packagingTypeForService5 = pakagingOptionDefault + "<option value='5'>Envelope (Doc)</option>"
                + "<option value='6'>Package</option>";
            var serviceValue = $(this).val();
            var packagingTypeElement = $("#packagingSelect");
            if (serviceValue == '1' || serviceValue == '2')
                packagingTypeElement.html(packagingTypeForService1Or2);
            if (serviceValue == '3' || serviceValue == '4')
                packagingTypeElement.html(packagingTypeForService3Or4);
            if (serviceValue == '5')
                packagingTypeElement.html(packagingTypeForService5);
        })
        // Event when choose packaging type
        $("#packagingSelect").change(function () {
            var option1 = weightOptionDefault + "<option value='1'>0-2.5kg</option>";
            var option2 = weightOptionDefault + "<option value='2'>0.5-2.5kg</option>";
            var option3 = weightOptionDefault + "<option value='3'>0.5-99.999kg</option>";
            var option4 = weightOptionDefault + "<option value='4'>Above 68kg -99.999kg</option>";

            var packagingValue = $(this).val();
            var weightElement = $("#weightSelect");

            if (packagingValue == '0' || packagingValue == '5') {
                $('#heightGroup').attr('hidden', false);
                $('#widthGroup').attr('hidden', false);
                $('#lengthGroup').attr('hidden', false);
                weightElement.html(option1);
            }
            if (packagingValue == '1' || packagingValue == '5') {
                $('#heightGroup').attr('hidden', true);
                $('#widthGroup').attr('hidden', true);
                $('#lengthGroup').attr('hidden', true);
                weightElement.html(option1);
            }

            if (packagingValue == '2') {
                $('#heightGroup').attr('hidden', false);
                $('#widthGroup').attr('hidden', false);
                $('#lengthGroup').attr('hidden', false);
                weightElement.html(option2);
            }

            if (packagingValue == '3' || packagingValue == '6') {
                $('#heightGroup').attr('hidden', false);
                $('#widthGroup').attr('hidden', false);
                $('#lengthGroup').attr('hidden', false);
                weightElement.html(option3);
            }




        })
        
        $("#searchButton").click(function () {
            var source = $("#sourceSelect").val();
            var desination = $("#destinationSelect").val();
            var carrier = $("#carrierSelect").val();
            var serviceValue = $("#servicesSelect").val();
            var packagingSelect = $("#packagingSelect").val();
            var weightSelect = $("#weightSelect").val();
            var height = $("#txtHeight").val();
            var length = $("#txtLength").val();
            var width = $("#txtWidth").val();

            var contentToRemove = document.querySelectorAll("#tr-id");
            $(contentToRemove).remove();
            if (source == "" || desination == "") {
                alert('Source, destination are not empty');
                return false;
            }
            if ($("#carrierSelect").val() !== "0") {
                if (($("#servicesSelect").val() === "0") || ($("#packagingSelect").val() === "0")) {
                    alert('Service, Packaging are not empty');
                    return false;
                }
            }
            $.ajax({
                type: "POST",
                url: "/Calculator/GetPriceAdvance",
                data: JSON.stringify({
                    "Length": length,
                    "Height": height,
                    "Width": width,
                    "From": source,
                    "To": desination,
                    "ServiceType": serviceValue,
                    "PackageType": packagingSelect,
                    "Region": "",
                    "Weight": weightSelect
                }),
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function (response) {
                    var count = 0;

                    for (var i = 0; i < response.data.Data.length; i++) {
                        var item = response.data.Data[i];
                        if (carrier == '' || carrier == item.CARRIER_NAME) {
                            count++;
                            $('<tr id="tr-id">')
                                .append($('<td>').append(item.CARRIER_NAME))
                                .append($('<td>').append(item.SERVICE_TYPE))
                                .append($('<td>').append(item.PACKAGE_TYPE))
                                .append($('<td>').append(item.WEIGHT_RANGE))
                                .append($('<td>').append(item.SURCHARGE))
                                .append($('<td>').append(item.WORKING_DAYS))
                                .append($('<td>').append(item.COST))
                                .append($('<td>').append(item.COST * (1 + item.SURCHARGE / 100)))
                                .appendTo('table tbody');
                        }
                    }

                    if (count == 0) {
                        $('<tr id="tr-id">')
                            .append($('<td colspan="8">').append("Can not found"))
                            .appendTo('table tbody');
                    }
                }
            });
        })
    })
    $(document).ready(function () {
        var role = $("#role").val();
        if (role == "sa") {
            $("#uprate").css("display", "block");
            $("#surrate").css("display", "block");
            $("#asrole").css("display", "block");
        }
        else {
            $("#uprate").css("display", "none");
            $("#surrate").css("display", "none");
            $("#asrole").css("display", "none");
        }
    });
    function search() {
        // Declare variables
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("tbResult");
        tr = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
